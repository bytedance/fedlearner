load("@rules_python//python:defs.bzl", "py_library")

package(default_visibility = ["//web_console_v2/api:console_api_package"])

py_library(
    name = "controller_lib",
    srcs = ["controller.py"],
    imports = ["../.."],
    deps = [
        ":models_lib",
        ":service_lib",
        ":utils_lib",
        ":yaml_formatter_lib",
        "//web_console_v2/api/fedlearner_webconsole/participant:services_lib",
        "//web_console_v2/api/fedlearner_webconsole/project:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/rpc:client_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:metrics_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:pp_datetime_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:resource_name_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:workflow_lib",
        "//web_console_v2/api/protocols/fedlearner_webconsole/proto:py_proto",
        "@common_sqlalchemy//:pkg",
    ],
)

py_test(
    name = "controller_lib_test",
    size = "small",
    srcs = [
        "controller_test.py",
    ],
    imports = ["../.."],
    main = "controller_test.py",
    deps = [
        ":controller_lib",
        "//web_console_v2/api/fedlearner_webconsole:db_lib",
        "//web_console_v2/api/fedlearner_webconsole/job:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/job:yaml_formatter_lib",
        "//web_console_v2/api/fedlearner_webconsole/participant:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/project:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:const_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:pp_datetime_lib",
        "//web_console_v2/api/fedlearner_webconsole/workflow:models_lib",
        "//web_console_v2/api/protocols/fedlearner_webconsole/proto:py_proto",
        "//web_console_v2/api/testing:no_web_server_test_case_lib",
        "@com_google_protobuf//:protobuf_python",
    ],
)

py_library(
    name = "crd_lib",
    srcs = ["crd.py"],
    imports = ["../.."],
    deps = [
        "//web_console_v2/api/fedlearner_webconsole/k8s:k8s_cache_lib",
        "//web_console_v2/api/fedlearner_webconsole/k8s:k8s_client_lib",
        "//web_console_v2/api/fedlearner_webconsole/k8s:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:metrics_lib",
    ],
)

py_library(
    name = "metrics_lib",
    srcs = ["metrics.py"],
    imports = ["../.."],
    deps = [
        ":models_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:es_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:job_metrics_lib",
        "@com_google_protobuf//:protobuf_python",
        "@common_matplotlib//:pkg",
        "@common_mpld3//:pkg",
    ],
)

py_test(
    name = "metrics_lib_test",
    size = "medium",
    srcs = [
        "metrics_test.py",
    ],
    imports = ["../.."],
    main = "metrics_test.py",
    deps = [
        ":metrics_lib",
        "//web_console_v2/api/testing:common_lib",
        "//web_console_v2/api/testing/test_data:test_data_lib",
    ],
)

py_library(
    name = "models_lib",
    srcs = ["models.py"],
    imports = ["../.."],
    deps = [
        ":crd_lib",
        "//web_console_v2/api/fedlearner_webconsole:db_lib",
        "//web_console_v2/api/fedlearner_webconsole/k8s:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/project:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:mixins_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:pp_datetime_lib",
        "//web_console_v2/api/protocols/fedlearner_webconsole/proto:py_proto",
        "@com_google_protobuf//:protobuf_python",
        "@common_sqlalchemy//:pkg",
    ],
)

py_test(
    name = "models_lib_test",
    size = "small",
    srcs = [
        "model_test.py",
    ],
    imports = ["../.."],
    main = "model_test.py",
    deps = [
        ":models_lib",
        "//web_console_v2/api/fedlearner_webconsole:db_lib",
        "//web_console_v2/api/fedlearner_webconsole/k8s:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:pp_datetime_lib",
        "//web_console_v2/api/fedlearner_webconsole/workflow:models_lib",
        "//web_console_v2/api/protocols/fedlearner_webconsole/proto:py_proto",
        "//web_console_v2/api/testing:no_web_server_test_case_lib",
    ],
)

py_library(
    name = "service_lib",
    srcs = ["service.py"],
    imports = ["../.."],
    deps = [
        ":models_lib",
        ":utils_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:metrics_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:pp_datetime_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:pp_yaml_lib",
        "//web_console_v2/api/protocols/fedlearner_webconsole/proto:py_proto",
        "@com_google_protobuf//:protobuf_python",
        "@common_sqlalchemy//:pkg",
    ],
)

py_test(
    name = "service_lib_test",
    size = "small",
    srcs = [
        "service_test.py",
    ],
    imports = ["../.."],
    main = "service_test.py",
    deps = [
        ":service_lib",
        "//web_console_v2/api/fedlearner_webconsole:db_lib",
        "//web_console_v2/api/fedlearner_webconsole/job:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/k8s:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:pp_datetime_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:pp_yaml_lib",
        "//web_console_v2/api/fedlearner_webconsole/workflow:models_lib",
        "//web_console_v2/api/protocols/fedlearner_webconsole/proto:py_proto",
        "//web_console_v2/api/testing:no_web_server_test_case_lib",
        "@com_google_protobuf//:protobuf_python",
    ],
)

py_library(
    name = "utils_lib",
    srcs = ["utils.py"],
    imports = ["../.."],
    deps = ["//web_console_v2/api/fedlearner_webconsole/utils:metrics_lib"],
)

py_test(
    name = "utils_test",
    size = "small",
    srcs = [
        "utils_test.py",
    ],
    imports = ["../.."],
    main = "utils_test.py",
    deps = [
        ":utils_lib",
    ],
)

py_library(
    name = "yaml_formatter_lib",
    srcs = ["yaml_formatter.py"],
    imports = ["../.."],
    deps = [
        "//web_console_v2/api/fedlearner_webconsole/k8s:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/rpc:client_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:const_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:pp_yaml_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:proto_lib",
        "//web_console_v2/api/protocols/fedlearner_webconsole/proto:py_proto",
    ],
)

py_test(
    name = "yaml_formatter_lib_test",
    size = "small",
    srcs = [
        "yaml_formatter_test.py",
    ],
    imports = ["../.."],
    main = "yaml_formatter_test.py",
    deps = [
        ":yaml_formatter_lib",
        "//web_console_v2/api/fedlearner_webconsole:db_lib",
        "//web_console_v2/api/fedlearner_webconsole/job:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/participant:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/project:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:pp_yaml_lib",
        "//web_console_v2/api/fedlearner_webconsole/workflow:models_lib",
        "//web_console_v2/api/protocols/fedlearner_webconsole/proto:py_proto",
        "//web_console_v2/api/testing:no_web_server_test_case_lib",
        "@com_google_protobuf//:protobuf_python",
    ],
)

py_library(
    name = "scheduler_lib",
    srcs = [
        "scheduler.py",
    ],
    imports = ["../.."],
    deps = [
        ":controller_lib",
        ":models_lib",
        "//web_console_v2/api/fedlearner_webconsole:db_lib",
        "//web_console_v2/api/fedlearner_webconsole/composer:common_lib",
        "//web_console_v2/api/protocols/fedlearner_webconsole/proto:py_proto",
    ],
)

py_test(
    name = "scheduler_lib_test",
    size = "small",
    srcs = [
        "scheduler_test.py",
    ],
    imports = ["../.."],
    main = "scheduler_test.py",
    deps = [
        ":scheduler_lib",
        "//web_console_v2/api/fedlearner_webconsole:db_lib",
        "//web_console_v2/api/fedlearner_webconsole/composer:common_lib",
        "//web_console_v2/api/fedlearner_webconsole/job:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/workflow:models_lib",
        "//web_console_v2/api/protocols/fedlearner_webconsole/proto:py_proto",
        "//web_console_v2/api/testing:no_web_server_test_case_lib",
        "@com_google_protobuf//:protobuf_python",
    ],
)

py_library(
    name = "apis_lib",
    srcs = ["apis.py"],
    imports = ["../.."],
    deps = [
        ":metrics_lib",
        ":models_lib",
        ":service_lib",
        "//web_console_v2/api:envs_lib",
        "//web_console_v2/api/fedlearner_webconsole:db_lib",
        "//web_console_v2/api/fedlearner_webconsole:exceptions_lib",
        "//web_console_v2/api/fedlearner_webconsole/auth:third_party_sso_lib",
        "//web_console_v2/api/fedlearner_webconsole/participant:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/project:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/rpc:client_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:es_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:flask_utils_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:kibana_lib",
        "//web_console_v2/api/fedlearner_webconsole/workflow:models_lib",
        "//web_console_v2/api/protocols/fedlearner_webconsole/proto:py_proto",
        "@com_google_protobuf//:protobuf_python",
        "@common_flask_restful//:pkg",
        "@common_marshmallow//:pkg",
        "@common_sqlalchemy//:pkg",
        "@common_webargs//:pkg",
    ],
)

py_test(
    name = "apis_lib_test",
    size = "medium",
    srcs = [
        "apis_test.py",
    ],
    imports = ["../.."],
    main = "apis_test.py",
    deps = [
        ":apis_lib",
        "//web_console_v2/api/fedlearner_webconsole:db_lib",
        "//web_console_v2/api/fedlearner_webconsole/job:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/utils:pp_datetime_lib",
        "//web_console_v2/api/protocols/fedlearner_webconsole/proto:py_proto",
        "//web_console_v2/api/testing:common_lib",
        "@com_google_protobuf//:protobuf_python",
    ],
)

py_library(
    name = "event_listener_lib",
    srcs = ["event_listener.py"],
    imports = ["../.."],
    deps = [
        ":models_lib",
        ":service_lib",
        "//web_console_v2/api/fedlearner_webconsole:db_lib",
        "//web_console_v2/api/fedlearner_webconsole/k8s:event_listener_lib",
        "//web_console_v2/api/fedlearner_webconsole/k8s:k8s_cache_lib",
        "//web_console_v2/api/fedlearner_webconsole/workflow:models_lib",
        "//web_console_v2/api/fedlearner_webconsole/workflow:service_lib",
        "//web_console_v2/api/fedlearner_webconsole/workflow:workflow_job_controller_lib",
    ],
)

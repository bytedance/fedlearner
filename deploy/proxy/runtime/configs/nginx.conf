#user auto;
worker_processes 1;
worker_rlimit_nofile 65536;
daemon off;

#FIXME Need rename the error log path
error_log ./logs/error.log info;
working_directory ./logs/;
worker_shutdown_timeout 1h;

events {
    worker_connections  65536;
    use epoll;
}

http {
	##
	# Basic Settings
	##

	sendfile on;
	tcp_nopush on; 
	tcp_nodelay on;
	keepalive_timeout 65;
	#keepalive_timeout 15;
	types_hash_max_size 2048;
	# server_tokens off;

	server_names_hash_bucket_size 128;
	# server_name_in_redirect off;

	include ./mime.types;
	default_type application/octet-stream;

	##
	# Gzip Settings
	##

	gzip on;
	gzip_disable "msie6";

	gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/xml text/javascript application/x-javascript application/json "application/octet-stream; ssmix=a";
    gzip_proxied any;
    gzip_vary on;
    gzip_http_version 1.1;
    proxy_http_version 1.1;

    # add header
    add_header Vary Accept-Encoding;

    # hack. init rid variable in http context
    lua_package_path "xcur_dir/liblua/?.lua;;";
    lua_package_cpath "xcur_dir/libso/?.so;;";

    log_format xlog '$http_host $remote_addr $remote_port $remote_user [$time_local] $request_time '
    '"$request" $status $body_bytes_sent '
    '"$http_referer" "$http_user_agent" "$http_host" "$http_cookie" '
    '"$upstream_response_time" $upstream_addr "$http_x_forwarded_for" $scheme '
    '"$upstream_http_set_cookie"';

    access_log ./logs/access.log xlog;

    #ssl settings
    ssl_stapling on;
    ssl_stapling_verify on;

    #ssl global ticket key rotation
    # SSL session ticket key sharing
    # Put a dummy key to trigger external ticket key usage in nginx/OpenSSL
    # init_by_lua* will replace this dummy key with existing cached keys
    # or a random key if cached keys are not available.

    ssl_prefer_server_ciphers on;
    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5;
    #ssl_dhparam 2048-bit-dhparams.pem;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    #change the proxy_temp_path, root partition size too small
    large_client_header_buffers 8 16k;
    client_max_body_size 512g;
    client_body_buffer_size 32k;


    server   {
        #for ingress traffic
        listen 9008 backlog=65536 reuseport default http2;
    
        #proxy_buffering off;
        #proxy_request_buffering off;
        #proxy_buffers 16 8k;
        #proxy_headers_hash_max_size 1024;
        #proxy_headers_hash_bucket_size 128;
        #proxy_next_upstream_tries 10;
        #proxy_intercept_errors on;
    
        set $backend_addr "";
        access_by_lua_file ./liblua/fl_router/access_router.lua;
    
        grpc_connect_timeout 60s;
        grpc_read_timeout 1800s;
        grpc_send_timeout 1800s;
        #grpc_next_upstream_tries 0;
        #grpc_socket_keepalive on;
        #proxy_next_upstream error timeout http_502 http_500;
    
        set $svc_name "";
        set $func_name "";
        location / {
            grpc_set_header ServiceName $svc_name;
            grpc_set_header FunctionName $func_name;
            grpc_pass grpc://$backend_addr;
        }
    }
    
    
    server   {
        #for egress traffic
        listen 9009 backlog=65536 reuseport default http2;
    
        #proxy_buffering off;
        #proxy_request_buffering off;
        #proxy_buffers 16 8k;
        #proxy_headers_hash_max_size 1024;
        #proxy_headers_hash_bucket_size 128;
        #proxy_next_upstream_tries 10;
        #proxy_intercept_errors on;
    
        set $backend_addr "";
        grpc_connect_timeout 60s;
        grpc_read_timeout 1800s;
        grpc_send_timeout 1800s;
        #grpc_next_upstream_tries 0;
        #grpc_socket_keepalive on;
        #proxy_next_upstream error timeout http_502 http_500;
    
        set $svc_name "";
        set $func_name "";
        location / {
            grpc_set_header ServiceName $svc_name;
            grpc_set_header FunctionName $func_name;
            grpc_pass grpc://127.0.0.1:80;
        }
    }
}
